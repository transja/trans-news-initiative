"Supporting equality",
"Loving America",
"Making the most of your opportunities",
"Connecting across differences",
"Being grateful for your opportunities as an American",
"Honoring the flag",
"Welcoming refugees",
"Being self-reliant"
)
# Assign names matching your plotting variable names
names(temp) <- paste0("duties_", 1:30)
Data_Clean <- Data_Clean %>%
mutate(urban_binary = case_when(
urban == "Urban" ~ "Urban",
urban %in% c("Suburban", "Rural") ~ "Suburban/Rural",
TRUE ~ NA_character_
))
Data_Clean <- Data_Clean %>%
mutate(ideology_tri = case_when(
ideology %in% c("Liberal", "Slightly liberal", "Very liberal") ~ "Liberal",
ideology %in% c("Moderate") ~ "Moderate",
ideology %in% c("Conservative", "Slightly conservative", "Very conservative") ~ "Conservative",
TRUE ~ NA_character_
))
Data_Clean <- Data_Clean %>%
mutate(age_binary = case_when(
age > 50 ~ "old",
age <= 50 ~ "young",
TRUE ~ NA_character_
))
predict_groups <- function(new_data_row, df, duty_cols, group_vars) {
predictions <- list()
for (group_var in group_vars) {
# Compute weighted prototypes for each group
prototype_df <- df %>%
filter(!is.na(.data[[group_var]])) %>%
group_by(.data[[group_var]]) %>%
summarise(across(all_of(duty_cols), ~ weighted.mean(.x, w = Weight, na.rm = TRUE)), .groups = "drop") %>%
rename(group = !!group_var)
# Compute Manhattan distance to each group prototype
distances <- prototype_df %>%
rowwise() %>%
mutate(dist = sum(abs(c_across(all_of(duty_cols)) - new_data_row))) %>%
ungroup()
# Identify the closest group
predicted_group <- distances$group[which.min(distances$dist)]
predictions[[group_var]] <- predicted_group
}
return(predictions)
}
# Define variables
duty_cols <- paste0("duties_", 1:30)
group_vars <- c("urban_binary", "ideology_tri", "age_binary")
# Example: Test out with the first row from existing dataset
new_participant <- Data_Clean[1, duty_cols]
for (i in 1:nrow(Data_Clean)) {
temp_new_participant <- Data_Clean[i, duty_cols]
predicted_categories <- predict_groups(temp_new_participant, Data_Clean, duty_cols, group_vars)
print(predicted_categories)
}
# Define variables
duty_cols <- paste0("duties_", 1:30)
group_vars <- c("urban_binary", "ideology_tri", "age_binary")
# Example: Test out with the first row from existing dataset
new_participant <- Data_Clean[1, duty_cols]
# for (i in 1:nrow(Data_Clean)) {
#   temp_new_participant <- Data_Clean[i, duty_cols]
#   predicted_categories <- predict_groups(temp_new_participant, Data_Clean, duty_cols, group_vars)
#   print(predicted_categories)
# }
#
Predict
# Define variables
duty_cols <- paste0("duties_", 1:30)
group_vars <- c("urban_binary", "ideology_tri", "age_binary")
# Example: Test out with the first row from existing dataset
new_participant <- Data_Clean[1, duty_cols]
# for (i in 1:nrow(Data_Clean)) {
#   temp_new_participant <- Data_Clean[i, duty_cols]
#   predicted_categories <- predict_groups(temp_new_participant, Data_Clean, duty_cols, group_vars)
#   print(predicted_categories)
# }
#
# Predict
predicted_categories <- predict_groups(new_participant, Data_Clean, duty_cols, group_vars)
print(predicted_categories)
# Define variables
duty_cols <- paste0("duties_", 1:30)
group_vars <- c("urban_binary", "ideology_tri", "age_binary")
# Example: Test out with the first row from existing dataset
new_participant <- Data_Clean[2, duty_cols]
# for (i in 1:nrow(Data_Clean)) {
#   temp_new_participant <- Data_Clean[i, duty_cols]
#   predicted_categories <- predict_groups(temp_new_participant, Data_Clean, duty_cols, group_vars)
#   print(predicted_categories)
# }
#
# Predict
predicted_categories <- predict_groups(new_participant, Data_Clean, duty_cols, group_vars)
print(predicted_categories)
# Define variables
duty_cols <- paste0("duties_", 1:30)
group_vars <- c("urban_binary", "ideology_tri", "age_binary")
# Example: Test out with the first row from existing dataset
new_participant <- Data_Clean[1, duty_cols]
# for (i in 1:nrow(Data_Clean)) {
#   temp_new_participant <- Data_Clean[i, duty_cols]
#   predicted_categories <- predict_groups(temp_new_participant, Data_Clean, duty_cols, group_vars)
#   print(predicted_categories)
# }
#
# Predict
predicted_categories <- predict_groups(new_participant, Data_Clean, duty_cols, group_vars)
print(predicted_categories)
predict_groups <- function(new_data_row, df, duty_cols, group_vars) {
predictions <- list()
for (group_var in group_vars) {
# Compute weighted prototypes for each group
prototype_df <- df %>%
filter(!is.na(.data[[group_var]])) %>%
group_by(.data[[group_var]]) %>%
summarise(across(all_of(duty_cols), ~ weighted.mean(.x, w = Weight, na.rm = TRUE)), .groups = "drop") %>%
rename(group = !!group_var)
# Compute Manhattan distance to each group prototype
distances <- prototype_df %>%
rowwise() %>%
mutate(dist = sum(abs(c_across(all_of(duty_cols)) - new_data_row))) %>%
ungroup()
print(distances)
# Identify the closest group
predicted_group <- distances$group[which.min(distances$dist)]
predictions[[group_var]] <- predicted_group
}
return(predictions)
}
# Define variables
duty_cols <- paste0("duties_", 1:30)
group_vars <- c("urban_binary", "ideology_tri", "age_binary")
# Example: Test out with the first row from existing dataset
new_participant <- Data_Clean[1, duty_cols]
# for (i in 1:nrow(Data_Clean)) {
#   temp_new_participant <- Data_Clean[i, duty_cols]
#   predicted_categories <- predict_groups(temp_new_participant, Data_Clean, duty_cols, group_vars)
#   print(predicted_categories)
# }
#
# Predict
predicted_categories <- predict_groups(new_participant, Data_Clean, duty_cols, group_vars)
print(predicted_categories)
# Define variables
duty_cols <- paste0("duties_", 1:30)
group_vars <- c("urban_binary", "ideology_tri", "age_binary")
# Example: Test out with the first row from existing dataset
new_participant <- Data_Clean[2, duty_cols]
# for (i in 1:nrow(Data_Clean)) {
#   temp_new_participant <- Data_Clean[i, duty_cols]
#   predicted_categories <- predict_groups(temp_new_participant, Data_Clean, duty_cols, group_vars)
#   print(predicted_categories)
# }
#
# Predict
predicted_categories <- predict_groups(new_participant, Data_Clean, duty_cols, group_vars)
print(predicted_categories)
# Define variables
duty_cols <- paste0("duties_", 1:30)
group_vars <- c("urban_binary", "ideology_tri", "age_binary")
# Example: Test out with the first row from existing dataset
new_participant <- Data_Clean[3, duty_cols]
# for (i in 1:nrow(Data_Clean)) {
#   temp_new_participant <- Data_Clean[i, duty_cols]
#   predicted_categories <- predict_groups(temp_new_participant, Data_Clean, duty_cols, group_vars)
#   print(predicted_categories)
# }
#
# Predict
predicted_categories <- predict_groups(new_participant, Data_Clean, duty_cols, group_vars)
print(predicted_categories)
# Define variables
duty_cols <- paste0("duties_", 1:30)
group_vars <- c("urban_binary", "ideology_tri", "age_binary")
# Example: Test out with the first row from existing dataset
new_participant <- Data_Clean[10, duty_cols]
# for (i in 1:nrow(Data_Clean)) {
#   temp_new_participant <- Data_Clean[i, duty_cols]
#   predicted_categories <- predict_groups(temp_new_participant, Data_Clean, duty_cols, group_vars)
#   print(predicted_categories)
# }
#
# Predict
predicted_categories <- predict_groups(new_participant, Data_Clean, duty_cols, group_vars)
print(predicted_categories)
# Define variables
duty_cols <- paste0("duties_", 1:30)
group_vars <- c("urban_binary", "ideology_tri", "age_binary")
# Example: Test out with the first row from existing dataset
new_participant <- Data_Clean[5, duty_cols]
# for (i in 1:nrow(Data_Clean)) {
#   temp_new_participant <- Data_Clean[i, duty_cols]
#   predicted_categories <- predict_groups(temp_new_participant, Data_Clean, duty_cols, group_vars)
#   print(predicted_categories)
# }
#
# Predict
predicted_categories <- predict_groups(new_participant, Data_Clean, duty_cols, group_vars)
print(predicted_categories)
# Define variables
duty_cols <- paste0("duties_", 1:30)
group_vars <- c("urban_binary", "ideology_tri", "age_binary")
# Example: Test out with the first row from existing dataset
new_participant <- Data_Clean[4, duty_cols]
# for (i in 1:nrow(Data_Clean)) {
#   temp_new_participant <- Data_Clean[i, duty_cols]
#   predicted_categories <- predict_groups(temp_new_participant, Data_Clean, duty_cols, group_vars)
#   print(predicted_categories)
# }
#
# Predict
predicted_categories <- predict_groups(new_participant, Data_Clean, duty_cols, group_vars)
print(predicted_categories)
library(googlesheets4)
library(readr)
library(dplyr)
library(tidyr)
library(jsonlite)
library(fs)
library(purrr)
library(lubridate)
library(stringr)
# helper for safely coalescing NULL to ""
`%||%` <- function(a, b) if (is.null(a)) b else a
raw <- read_csv("joined_data_oct_2025.csv")
setwd("~/Documents/github/polygraph/2025/trans-news-initiative/admin")
raw <- read_csv("joined_data_oct_2025.csv")
override <- read_sheet("https://docs.google.com/spreadsheets/d/1yo59KnHsybeBC2rqcMkULDS7sBlwjBytP8VON9FU-0g/edit?gid=1449988544#gid=1449988544", "OVERRIDE_OCT2025")
df <- raw %>%
left_join(
override,
) %>%
mutate(
label = coalesce(labelOVERRIDE, label),
themes = coalesce(categoriesOVERRIDE, categories_above_floor)
) %>%
filter(
is.na(filterOVERRIDE),
publish_date < '2025-10-01'
) %>%
select(
title,
publish_date,
media_name,
url,
themes = categoriesOVERRIDE,
event = labelOVERRIDE
) %>%
mutate(event = case_when(
event == 'Noise' ~ NA,
TRUE ~ event
))
View(df)
raw <- read_csv("joined_data_oct_2025.csv")
override <- read_sheet("https://docs.google.com/spreadsheets/d/1yo59KnHsybeBC2rqcMkULDS7sBlwjBytP8VON9FU-0g/edit?gid=1449988544#gid=1449988544", "OVERRIDE_OCT2025")
df <- raw %>%
left_join(
override,
) %>%
mutate(
label = coalesce(labelOVERRIDE, label),
themes = coalesce(categoriesOVERRIDE, categories_above_floor)
) %>%
filter(
is.na(filterOVERRIDE),
publish_date < '2025-10-01'
) %>%
select(
title,
publish_date,
media_name,
url,
themes = categoriesOVERRIDE,
event = labelOVERRIDE
) %>%
mutate(event = case_when(
event == 'Noise' ~ NA,
TRUE ~ event
))
View(df)
View(df)
View(raw)
# helper for safely coalescing NULL to ""
`%||%` <- function(a, b) if (is.null(a)) b else a
raw <- read_csv("joined_data_oct_2025.csv")
override <- read_sheet("https://docs.google.com/spreadsheets/d/1yo59KnHsybeBC2rqcMkULDS7sBlwjBytP8VON9FU-0g/edit?gid=1449988544#gid=1449988544", "OVERRIDE_OCT2025")
library(googlesheets4)
library(readr)
library(dplyr)
library(tidyr)
library(jsonlite)
library(fs)
library(purrr)
library(lubridate)
library(stringr)
# helper for safely coalescing NULL to ""
`%||%` <- function(a, b) if (is.null(a)) b else a
raw <- read_csv("joined_data_oct_2025.csv")
override <- read_sheet("https://docs.google.com/spreadsheets/d/1yo59KnHsybeBC2rqcMkULDS7sBlwjBytP8VON9FU-0g/edit?gid=1449988544#gid=1449988544", "OVERRIDE_OCT2025")
View(override)
df <- raw %>%
left_join(
override,
) %>%
mutate(
label = coalesce(labelOVERRIDE, label),
themes = coalesce(categoriesOVERRIDE, categories_above_floor)
) %>%
filter(
is.na(filterOVERRIDE),
publish_date < '2025-11-01'
) %>%
select(
title,
publish_date,
media_name,
url,
themes = categoriesOVERRIDE,
event = labelOVERRIDE
) %>%
mutate(event = case_when(
event == 'Noise' ~ NA,
TRUE ~ event
))
View(df)
df <- raw %>%
left_join(
override,
) %>%
mutate(
label = coalesce(labelOVERRIDE, label),
themes = coalesce(categoriesOVERRIDE, categories_above_floor)
) %>%
filter(
is.na(filterOVERRIDE),
publish_date < '2025-11-01'
) %>% View()
select(
title,
publish_date,
media_name,
url,
themes,
event = label
) %>%
mutate(event = case_when(
event == 'Noise' ~ NA,
TRUE ~ event
))
df <- raw %>%
left_join(
override,
) %>%
mutate(
label = coalesce(labelOVERRIDE, label),
themes = coalesce(categoriesOVERRIDE, categories_above_floor)
) %>%
filter(
is.na(filterOVERRIDE),
publish_date < '2025-11-01'
) %>%
select(
title,
publish_date,
media_name,
url,
themes,
event = label
) %>%
mutate(event = case_when(
event == 'Noise' ~ NA,
TRUE ~ event
))
View(df)
process_themes <- function(df, output_dir = "themes_json") {
# Ensure output directory exists
dir_create(output_dir)
# Split comma-separated themes only for grouping
df_grouped <- df %>%
mutate(theme_split = strsplit(themes, "\\s*,\\s*")) %>%
unnest(theme_split) %>%
mutate(theme_split = trimws(theme_split)) %>%
filter(theme_split != "")
# Group by each individual theme and write out JSON of full original rows
df_grouped %>%
group_split(theme_split) %>%
walk(function(group_data) {
theme_name <- unique(group_data$theme_split)
file_name <- paste0(output_dir, "/", gsub("[^a-zA-Z0-9_-]", "_", theme_name), ".json")
# Keep the original CSV 'themes' string in the JSON output
json <- toJSON(select(group_data, -theme_split), pretty = FALSE, auto_unbox = TRUE)
write_lines(json, file_name)
})
}
df %>%
filter(
"popCulture" %in% themes
)
df %>%
filter(
"popCulture" %in% themes
) %>% View()
df %>%
filter(
"popCulture" %in% themes,
media_name == "nytimes.com"
)
df %>%
filter(
"popCulture" %in% themes,
media_name == "nytimes.com"
) %>%  View()
df %>%
filter(
"popCulture" %in% themes,
media_name == "nytimes.com"
) %>%
group_by(event) %>%
summarise(
count = n()
) %>%
arrange(desc(count))
group_by(event) %>%
summarise(
count = n()
) %>%
arrange(desc(count))
df %>%
filter(
"popCulture" %in% themes
) %>%
filter(media_name == "nytimes.com") %>%
group_by(event) %>%
summarise(
count = n()
) %>%
arrange(desc(count))
df %>%
filter(
"freeSpeech" %in% themes
) %>%
filter(media_name == "nytimes.com") %>%
group_by(event) %>%
summarise(
count = n()
) %>%
arrange(desc(count))
df %>%
filter(
"popCulture" %in% themes
) %>%
filter(media_name == "nytimes.com") %>%
group_by(event) %>%
summarise(
count = n()
) %>%
arrange(desc(count))
df %>%
filter(media_name == "nytimes.com") %>%
group_by(event) %>%
summarise(
count = n()
) %>%
arrange(desc(count))
df %>%
filter(
grepl('popCulture', themes)
media_name == "nytimes.com"
df %>%
filter(
grepl('popCulture', themes),
media_name == "nytimes.com"
) %>%
group_by(event) %>%
summarise(
count = n()
) %>%
arrange(desc(count))
df %>%
filter(
grepl('popCulture', themes),
media_name == "nytimes.com"
) %>%
group_by(event) %>%
summarise(
count = n()
) %>%
filter(
!is.na(count),
count >= 10
) %>%
arrange(desc(count))
df %>%
filter(
grepl('popCulture', themes),
media_name == "nytimes.com"
) %>%
group_by(event) %>%
summarise(
count = n()
) %>%
filter(
!is.na(event),
count >= 10
) %>%
arrange(desc(count))
